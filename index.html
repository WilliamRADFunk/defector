<html>

<head>
	<!-- Resets all default browser stylings for a clean slate -->
    <link rel="stylesheet" href="css/reset_author_richard_clark.css">
    <!-- Styles specific to the Encryptor pages -->
    <link rel="stylesheet" href="css/styles.css">
    <!-- WebGL wrapper library -->
	<script src="js/external/three.js"></script>
	<!-- Allows for keyboard listeners -->
	<script src="js/external/threex.keyboardstate.js"></script>
</head>

<body>

<div id="container">
	<div id="mainview">
		<div id="HUD-timer">
			<div id="timer-container">
				<h4>TIMER</h4>
				<div id="minutes" class="time"></div>
				<div id="seconds" class="time"></div>
			</div>
		</div>
		<div id="HUD-legend">
			<div id="legend-container">
				<h4>KEYS</h4>
				<p>LEFT ------- A, left</p>
				<p>RIGHT ----- D, right</p>
				<p>UP ---------- W, up</p>
				<p>BACK ----- S, down</p>
				<p>TIME -------- space</p>
			</div>
		</div>
	</div>
	<div id="hudview"></div>
</div>

<script>
	var renderer, renderer2;
	var scene;
	var camera, hudcamera;
	var player;
	var updateCounter = 0;
	var timer = 36000;

	var map1 = [// 01, 02, 03, 04, 05, 06, 07, 08, 09, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19
			   [1, 1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1], // 00
			   [2, 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  2], // 01
			   [2, 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  2], // 02
			   [2, 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  2], // 03
			   [2, 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  2], // 04
			   [2, 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  2], // 05
			   [2, 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  2], // 06
			   [2, 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  2], // 07
			   [2, 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  2], // 08
			   [2, 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  2], // 09
			   [2, 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  2], // 10
			   [2, 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  2], // 11
			   [2, 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  2], // 12
			   [2, 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  2], // 13
			   [2, 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  2], // 14
			   [2, 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  2], // 15
			   [2, 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  2], // 16
			   [2, 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  2], // 17
			   [2, 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  2], // 18
			   [1, 1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1], // 19
			   ], map1Width = map1.length, map1Height = map1[0].length;

	var WALLHEIGHT = 15;
	var STRIDE = 0.7;
	var SCENEWIDTH = 200, SCENEHEIGHT = 200;
	var UNITSIZE = 10;
	
	keyboard = new THREEx.KeyboardState();
	
	function init()
	{
		scene = new THREE.Scene();
	
		camera = new THREE.PerspectiveCamera( 45, window.innerWidth / window.innerHeight, 0.1, 1000 );
		camera.position.x = 0;
		camera.position.y = 0;
		camera.position.z = 5;
		camera.rotation.x = 0;
		camera.rotation.y = 0;
		camera.rotation.z = 0;
		var pos = new THREE.Vector3( 0, 200, 0 );
		camera.lookAt( pos );
		
		//hudcamera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 3000 );
		hudcamera = new THREE.OrthographicCamera( -100, 100, 100, -100, 0.1, 3000, 1 );
		hudcamera.position.x = 0;
		hudcamera.position.y = 0;
		hudcamera.position.z = 300;
		hudcamera.lookAt( scene.position );
		
		renderer = new THREE.WebGLRenderer();
		renderer.setClearColor( 0x000000, 0 );
		renderer.setSize( window.innerWidth, window.innerHeight );
		renderer.shadowMapEnabled = true;

		renderer2 = new THREE.WebGLRenderer();
		renderer2.setClearColor( 0x000000, 0 );
		renderer2.setSize( 150, 150 );
		renderer2.shadowMapEnabled = false;
		
		addFloorCieling();
		addWalls();

		// add spotlight for the shadows
        var spotLight = new THREE.SpotLight( 0xffffff );
        spotLight.position.set( 10, 20, 20 );
        spotLight.shadowCameraNear = 20;
        spotLight.shadowCameraFar = 50;
        spotLight.castShadow = true;
        scene.add(spotLight);
		
		var playerGeometry = new THREE.SphereGeometry( 4 );
		var playerMaterial = new THREE.MeshBasicMaterial({color:'white'});
		player = new THREE.Mesh( playerGeometry, playerMaterial );
		scene.add( player );
		
		renderer.autoClear = false;
		renderer2.autoClear = false;

		var container = document.getElementById("mainview");
		document.body.appendChild( container );
		container.appendChild( renderer.domElement );
		
		var container2 = document.getElementById("hudview");
		document.body.appendChild( container2 );
		container2.appendChild( renderer2.domElement );
		
		render();
	}

		function addFloorCieling()
	{
		var floorTexture = THREE.ImageUtils.loadTexture('assets/textures/wood-floorboards-texture.jpg');
		floorTexture.wrapS = THREE.RepeatWrapping;
		floorTexture.wrapT = THREE.RepeatWrapping;
		floorTexture.repeat.set( 10, 10 );
		var floorGeometry = new THREE.BoxGeometry( SCENEWIDTH, SCENEHEIGHT, 1 );
		var floorMaterial = new THREE.MeshBasicMaterial({map:floorTexture});
		var floor = new THREE.Mesh( floorGeometry, floorMaterial );
		scene.add( floor );

		var ceilingTexture = THREE.ImageUtils.loadTexture('assets/textures/tile-ceiling.jpg');
		ceilingTexture.wrapS = THREE.RepeatWrapping;
		ceilingTexture.wrapT = THREE.RepeatWrapping;
		ceilingTexture.repeat.set( 30, 30 );
		var ceilingGeometry = new THREE.PlaneGeometry( SCENEWIDTH, SCENEHEIGHT, 1 );
		var ceilingMaterial = new THREE.MeshBasicMaterial( {map:ceilingTexture, side: THREE.BackSide} );
		var ceiling = new THREE.Mesh( ceilingGeometry, ceilingMaterial );
		ceiling.position.z = WALLHEIGHT;
		scene.add( ceiling );
	}
	
	function addAWall( x, y, z, xp, yp, zp, texture )
	{
		var wallg = new THREE.BoxGeometry( x, y, z );
		var wallm = new THREE.MeshBasicMaterial({map:texture});
		var wallmesh = new THREE.Mesh( wallg, wallm );
		wallmesh.position.z = zp;
		wallmesh.position.y = yp;
		wallmesh.position.x = xp;
		scene.add( wallmesh );
	}
	
	function addWalls()
	{
		var texture1 = THREE.ImageUtils.loadTexture('assets/textures/brick-1.jpg');
		texture1.wrapS = THREE.RepeatWrapping;
		texture1.wrapT = THREE.RepeatWrapping;
		texture1.repeat.set( 2, 1 );

		var texture2 = THREE.ImageUtils.loadTexture('assets/textures/brick-1.jpg');
		texture2.wrapS = THREE.RepeatWrapping;
		texture2.wrapT = THREE.RepeatWrapping;
		texture2.repeat.set( 1, 2 );

		var tileTexture = THREE.ImageUtils.loadTexture('assets/textures/tile-pentagon.jpg');
		tileTexture.wrapS = THREE.RepeatWrapping;
		tileTexture.wrapT = THREE.RepeatWrapping;
		tileTexture.repeat.set( 15, 1 );


		for(var i = 0; i < map1Width; i++)
		{
			for(var j = 0; j < map1Height; j++)
			{
				if(map1[i][j] == 0)
				{
					continue;
				}
				else if(map1[i][j] == 1)
				{
					addAWall( UNITSIZE, UNITSIZE, WALLHEIGHT, (i * UNITSIZE) - 100, (j * UNITSIZE) - 100, WALLHEIGHT / 2, texture1 );
				}
				else if(map1[i][j] == 2)
				{
					addAWall( UNITSIZE, UNITSIZE, WALLHEIGHT, (i * UNITSIZE) - 100, (j * UNITSIZE) - 100, WALLHEIGHT / 2, texture2 );
				}
			}
		}
		//addAWall( SCENEWIDTH, 5, WALLHEIGHT, 0, (SCENEHEIGHT / 2), WALLHEIGHT / 2, texturex );
		//addAWall( SCENEWIDTH, 5, WALLHEIGHT, 0, -(SCENEHEIGHT / 2), WALLHEIGHT / 2, texturex );
		//addAWall( 5, SCENEHEIGHT, WALLHEIGHT, -(SCENEWIDTH / 2), 0, WALLHEIGHT / 2, texturey );
		//addAWall( 5, SCENEHEIGHT, WALLHEIGHT, (SCENEWIDTH / 2), 0, WALLHEIGHT / 2, texturey );

		//addAWall(50, 5, WALLHEIGHT, -75, -60, 7.5, tileTexture);
	}

	function moveCamera( xd, yd )
	{
		var x = camera.position.x + STRIDE * Math.sin( camera.rotation.y ) * xd;
		var y = camera.position.y + STRIDE * Math.cos( camera.rotation.y ) * yd;
		
			
		camera.position.x = x;
		camera.position.y = y;
		
		player.position.x = camera.position.x;
		player.position.y = camera.position.y;
		player.position.z = camera.position.z;
	}
	
	function render()
	{
		updateCounter++;
		timer--;
		var minutes = Math.floor(timer / 3600);
		var seconds = Math.floor( (timer - (minutes * 3600)) / 60 );

		// Keeps track of the time.
		if(updateCounter % 59 == 0)
		{
			document.getElementById( 'minutes' ).innerHTML = minutes;
			document.getElementById( 'seconds' ).innerHTML = seconds;
		}

		if( keyboard.pressed("right") && keyboard.pressed("forward") )
		{
			camera.rotation.y -= 0.02;
			moveCamera( -1, 1 );
		}
		else if( keyboard.pressed("left") && keyboard.pressed("forward") )
		{
			camera.rotation.y += 0.02;
			moveCamera( -1, 1 );
		}
		else if( keyboard.pressed("right") && keyboard.pressed("backward") )
		{
			camera.rotation.y -= 0.02;
			moveCamera( 1, -1 );
		}
		else if( keyboard.pressed("left") && keyboard.pressed("backward") )
		{
			camera.rotation.y += 0.02;
			moveCamera( 1, -1 );
		}
		else if( keyboard.pressed("right") )
		{
			camera.rotation.y -= 0.02;
		}
		else if( keyboard.pressed("left") )
		{
			camera.rotation.y += 0.02;
		}
		else if( keyboard.pressed("forward") )
		{
			moveCamera( -1, 1 );
		}
		else if( keyboard.pressed("backward") )
		{
			moveCamera( 1, -1 );
		}
	
		requestAnimationFrame( render );
		
		renderer.setViewport( 0, 0, window.innerWidth, window.innerHeight );
		renderer.render( scene, camera );
		
		var aspect = 1;//window.innerWidth / window.innerHeight;
		renderer2.enableScissorTest(true);
		var horz_ratio = window.innerWidth/window.innerHeight;
		renderer2.setViewport( 0, 0, 150 * aspect, 150* aspect);
		//renderer2.setScissor( 0, 0, 200 * aspect/horz_ratio, 200* aspect*horz_ratio  );
		renderer2.render( scene, hudcamera );
	}
	
	window.onload = init;
</script>

<script>
</script>

</body>

</html>
